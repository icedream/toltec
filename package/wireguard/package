#!/usr/bin/env bash
# Copyright (c) 2021 The Toltec Contributors
# SPDX-License-Identifier: MIT

pkgnames=(wireguard)
pkgdesc="Fast, modern, secure VPN tunnel"
url=https://www.wireguard.com
pkgver=1.0.20220627-1
_wireguardtoolsver=1.0.20210914
timestamp=2021-09-13T22:43Z
section=kernel
maintainer="Jonah Weissman <jonahrweissman+toltec@gmail.com>"
license=GPL-2.0-only
makedepends=(build:bc build:bison build:flex build:lzop build:libssl-dev build:git)
flags=(nostrip)

_kernelrepo=https://github.com/remarkable/linux
_kernelrevs=(
    RM1XX_5.4.70_v1.2.6
    RM1XX_5.4.70_v1.2.6
)
_defconfigs=(
    arch/arm/configs/zero-sugar_defconfig
    arch/arm/configs/zero-sugar-evk_defconfig
)

image=base:v2.1
source=(
    "https://git.zx2c4.com/wireguard-linux-compat/snapshot/wireguard-linux-compat-${pkgver%-*}.tar.xz"
    "https://git.zx2c4.com/wireguard-tools/snapshot/wireguard-tools-${_wireguardtoolsver}.tar.xz"
    fix-multiple-yylloc-definitions.patch
)
noextract=("wireguard-tools-${_wireguardtoolsver}.tar.xz")
sha256sums=(
    362d412693c8fe82de00283435818d5c5def7f15e2433a07a9fe99d0518f63c0
    97ff31489217bb265b7ae850d3d0f335ab07d2652ba1feec88b734bc96bd05ac
    SKIP
)

prepare() {
    bsdtar -x \
        --directory "$srcdir" \
        --file "$srcdir/wireguard-tools-${_wireguardtoolsver}.tar.xz"
    mv "$srcdir/wireguard-tools-${_wireguardtoolsver}" "$srcdir/wireguard-tools"
    # the symlink at src/wg-quick/wg needs something to point to
    touch "$srcdir/wireguard-tools/src/wg"
}

build() {
    make -C wireguard-tools/src PLATFORM=linux "CC=${CROSS_COMPILE}cc"

    mkdir pkg
    git init linux
    for i in $(seq 0 1); do
        (
            cd linux
            git fetch --depth=1 --tags "$_kernelrepo" "${_kernelrevs[$i]}"
            git checkout -f "${_kernelrevs[$i]}"
            git apply "$srcdir"/fix-multiple-yylloc-definitions.patch || true
            make mrproper
            touch .scmversion
            cp "${_defconfigs[$i]}" .config
            echo "CONFIG_NET_FOU=m" >> .config
            make olddefconfig
            make net/ipv4/udp_tunnel.ko
            make net/ipv6/ip6_udp_tunnel.ko
            make modules_prepare
        )

        make -C src/ "KERNELDIR=$(realpath linux)"
        KERNELRELEASE=$(cat linux/include/config/kernel.release)
        export MOD_INSTALL_PATH="pkg/$KERNELRELEASE"
        install -D -m 644 linux/net/ipv4/udp_tunnel.ko \
            "$MOD_INSTALL_PATH/kernel/net/ipv4/udp_tunnel.ko"
        install -D -m 644 linux/net/ipv6/ip6_udp_tunnel.ko \
            "$MOD_INSTALL_PATH/kernel/net/ipv6/ip6_udp_tunnel.ko"
        install -D -m 644 src/wireguard.ko \
            "$MOD_INSTALL_PATH/extra/wireguard.ko"
    done
}

package() {
    make -C "$srcdir/wireguard-tools/src" DESTDIR="$pkgdir" WITH_WGQUICK=yes \
        WITH_SYSTEMDUNITS=yes WITH_BASHCOMPLETION=no install
    mkdir -p "$pkgdir/lib/modules"
    cp -r "$srcdir/pkg"/* "$pkgdir/lib/modules"
}

configure() {
    depmod -a
}

postremove() {
    cat << MSG
Wireguard has been removed.
The kernel module will remain loaded until you reboot, or you can attempt
to manually remove it by running "modprobe -r wireguard".
MSG
    depmod -a
}

postupgrade() {
    cat << MSG
Wireguard has been upgraded.
The old kernel module will remain loaded until you reboot, or you can
attempt to manually remove it by running "modprobe -r wireguard".
MSG
}
